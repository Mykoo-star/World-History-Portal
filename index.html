<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>World History Portal</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.6/purify.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=EB+Garamond:wght@400;700&family=Merriweather:wght@300;400;700&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: { extend: { colors: { 'brand-purple': '#6D4C41', 'brand-cyan': '#A1887F', 'card-bg': '#F5F0E6', 'main-text': '#3E2723' } } }
        }
    </script>

    <style>
        /* --- CSS MANUAL (ENHANCED) --- */
        :root {
            --color-primary: #5D4037; 
            --color-accent: #8D6E63;   
            --color-bg: #EBE3D5;      
            --color-card: rgba(245, 240, 230, 0.65); 
            --color-text: #3E2723;
            --color-red: #D21F3C;
            --color-green: #2E7D32;
            --shadow-soft: 0 10px 30px rgba(62, 39, 35, 0.15);
        }

        * { box-sizing: border-box; }

        body {
            margin: 0;
            padding: 0;
            font-family: 'Merriweather', serif;
            color: var(--color-text);
            /* Background dihandle oleh div terpisah untuk slideshow */
            background-color: #1a1a1a; 
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            overflow-x: hidden;
        }

        /* --- BACKGROUND SLIDESHOW --- */
        #bg-slideshow {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -2;
            background-color: #000;
        }
        
        .bg-slide {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-size: cover;
            background-position: center;
            opacity: 0;
            transition: opacity 2.5s ease-in-out; /* Transisi lebih lambat agar smooth */
            z-index: -1;
        }

        .bg-slide.active {
            opacity: 1;
            z-index: 0; /* Pastikan yang aktif di atas */
        }

        /* Overlay gelap agar teks putih terbaca */
        .bg-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5); /* Sedikit lebih gelap (50%) untuk kontras gambar baru */
            z-index: -1;
            pointer-events: none;
        }

        /* Header Styles */
        .site-header {
            background-color: rgba(235, 227, 213, 0.95);
            border-bottom: 1px solid rgba(93, 64, 55, 0.2);
            padding: 1rem;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
            backdrop-filter: blur(10px);
        }
        .header-content {
            max-width: 1000px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 10px;
        }
        .logo-area { display: flex; align-items: center; gap: 12px; }
        .logo-icon { width: 36px; height: 36px; color: var(--color-primary); }
        .site-title {
            font-family: 'Cinzel', serif;
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--color-primary);
            margin: 0;
        }
        
        /* Library Button */
        .library-btn {
            font-family: 'Cinzel', serif;
            background: transparent;
            border: 2px solid var(--color-primary);
            color: var(--color-primary);
            padding: 6px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
        }
        .library-btn:hover { background: var(--color-primary); color: #fff; }

        .main-container { flex: 1; width: 100%; max-width: 900px; margin: 0 auto; padding: 2rem 1rem; display: flex; flex-direction: column; justify-content: center;}

        /* --- CARD STYLES MODIFIED FOR TRANSPARENCY --- */
        
        /* Kelas umum untuk kartu hasil (tetap solid) */
        .card-result {
            background-color: var(--color-card);
            border-radius: 16px;
            box-shadow: var(--shadow-soft);
            padding: 2.5rem;
            margin-bottom: 2rem;
            border: 1px solid rgba(255,255,255,0.5);
            text-align: center;
            animation: slideUp 0.6s ease-out;
            position: relative;
        }

        /* ID khusus untuk Search Card (Transparan) */
        #searchCard {
            background: transparent;
            box-shadow: none;
            border: none;
            text-align: center;
            padding: 2rem 1rem;
            animation: fadeIn 1s ease-out;
        }

        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* Typography untuk Search Screen (Putih dengan Shadow) */
        #searchCard .hero-title {
            font-family: 'Cinzel', serif;
            font-size: 3rem; /* Lebih besar */
            margin-bottom: 0.5rem;
            color: #FFFFFF; /* Text Putih */
            font-weight: 800;
            text-shadow: 0 4px 15px rgba(0,0,0,0.9); /* Shadow Kuat */
            letter-spacing: 2px;
        }
        
        #searchCard .subtitle { 
            color: #E0E0E0; 
            font-size: 1.2rem; 
            margin-bottom: 2.5rem; 
            text-shadow: 0 2px 8px rgba(0,0,0,0.9);
            font-weight: 500;
        }

        #searchCard label {
            color: #FFF !important;
            text-shadow: 0 2px 4px rgba(0,0,0,0.9);
            font-weight: bold;
            letter-spacing: 1px;
        }
        
        /* Form Elements (Glassmorphism) */
        .styled-select, .styled-input {
            width: 100%;
            padding: 14px 20px;
            border: 1px solid rgba(255, 255, 255, 0.4);
            border-radius: 30px; /* Lebih bulat */
            font-size: 1rem;
            font-family: inherit;
            background: rgba(255, 255, 255, 0.85); /* Semi transparan putih */
            backdrop-filter: blur(5px);
            outline: none;
            transition: all 0.3s ease;
            color: #3E2723;
            font-weight: 600;
        }
        .styled-select:focus, .styled-input:focus { 
            background: #fff;
            box-shadow: 0 0 15px rgba(255, 255, 255, 0.5);
            border-color: #fff;
        }

        .search-box { position: relative; margin-top: 1.5rem; max-width: 600px; margin-left: auto; margin-right: auto; }
        .search-icon {
            position: absolute; left: 20px; top: 50%; transform: translateY(-50%);
            color: var(--color-primary); width: 24px; height: 24px;
            z-index: 10;
        }
        .styled-input-search { padding-left: 55px; padding-right: 130px; font-size: 1.1rem; box-shadow: 0 4px 20px rgba(0,0,0,0.3); }
        
        .search-btn {
            position: absolute; right: 6px; top: 6px; bottom: 6px;
            background-color: var(--color-primary); color: white;
            border: none; border-radius: 25px; padding: 0 25px;
            font-weight: bold; cursor: pointer; font-family: 'Cinzel', serif;
            transition: all 0.3s;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .search-btn:hover { background-color: #3E2723; transform: scale(1.05); }

        /* Chips */
        .chips-container { display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; margin-top: 2rem; }
        .chip {
            background: rgba(0, 0, 0, 0.5); /* Gelap transparan */
            border: 1px solid rgba(255, 255, 255, 0.4); 
            padding: 10px 20px;
            border-radius: 25px; font-size: 0.95rem; color: #fff;
            cursor: pointer; transition: all 0.3s; font-weight: 600;
            backdrop-filter: blur(4px);
            text-shadow: 0 1px 2px rgba(0,0,0,0.8);
        }
        .chip:hover { background: #fff; color: var(--color-primary); border-color: #fff; text-shadow: none; transform: translateY(-3px); }

        /* --- LOADER --- */
        .loader-container { display: none; flex-direction: column; align-items: center; padding: 3rem 0; background: rgba(255,255,255,0.9); border-radius: 16px; margin-top: 2rem;}
        
        .portal-ring {
            position: relative;
            width: 80px; height: 80px;
            margin-bottom: 1.5rem;
        }
        .ring-inner, .ring-outer {
            position: absolute;
            border-radius: 50%;
            border: 4px solid transparent;
        }
        .ring-outer {
            top: 0; left: 0; width: 100%; height: 100%;
            border-top-color: var(--color-primary);
            border-bottom-color: var(--color-accent);
            animation: spinReverse 2s linear infinite;
        }
        .ring-inner {
            top: 15px; left: 15px; width: 50px; height: 50px;
            border-left-color: var(--color-primary);
            border-right-color: var(--color-accent);
            animation: spin 1.5s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes spinReverse { 0% { transform: rotate(0deg); } 100% { transform: rotate(-360deg); } }

        .cancel-btn {
            margin-top: 15px; background: transparent; border: 1px solid var(--color-red);
            color: var(--color-red); padding: 6px 16px; border-radius: 20px;
            font-size: 0.85rem; cursor: pointer; transition: 0.2s;
        }
        .cancel-btn:hover { background: var(--color-red); color: white; }

        /* Content Typography (Inside Result Card) */
        .article-content { text-align: left; line-height: 1.8; color: #2D2420; }
        .article-content h1 { 
            font-family: 'Cinzel', serif; font-size: 2.2rem; color: #2D2420; 
            border-bottom: 2px solid var(--color-accent); padding-bottom: 10px; margin-bottom: 1.5rem;
            text-align: center; 
        }
        .article-content h2 { 
            font-family: 'Cinzel', serif; font-size: 1.6rem; color: var(--color-primary); 
            margin-top: 2.5rem; margin-bottom: 1rem; border-bottom: 1px solid rgba(0,0,0,0.1);
            padding-bottom: 5px; clear: both;
        }
        .article-content p { margin-bottom: 1.2rem; font-size: 1.05rem; text-align: justify; }
        .article-content strong { color: var(--color-red); font-weight: 700; }
        .article-content ul { padding-left: 20px; border-left: 3px solid rgba(141, 110, 99, 0.3); margin: 1.5rem 0 1.5rem 10px; list-style: none; clear: both; }
        .article-content ul li { margin-bottom: 0.8rem; position: relative; padding-left: 10px; }
        .article-content blockquote { 
            border-left: 5px solid var(--color-primary); margin: 2rem 0; 
            padding: 1rem 1.5rem; background: rgba(141, 110, 99, 0.1); 
            font-style: italic; border-radius: 0 8px 8px 0; clear: both;
        }

        /* Fun Fact Styles */
        .fun-fact-box {
            margin: 2rem 0; padding: 1.5rem; background-color: #FFF8E1; 
            border: 2px solid #FFC107; border-radius: 12px; position: relative;
            animation: slideUp 0.8s ease;
        }
        .fun-fact-title {
            font-family: 'Cinzel', serif; color: #D4A017; font-weight: bold;
            display: flex; align-items: center; gap: 8px; margin-bottom: 0.5rem;
        }

        /* Table Styles */
        .table-scroll-container { width: 100%; overflow-x: auto; margin: 2rem 0; box-shadow: 0 2px 5px rgba(0,0,0,0.1); border: 1px solid #8D6E63; border-radius: 8px; }
        .article-content table { width: 100%; min-width: 600px; border-collapse: collapse; font-size: 0.95rem; background-color: #fff; }
        .article-content th, .article-content td { border: 1px solid #5D4037; padding: 12px 15px; text-align: left; }
        .article-content th { background-color: #D7CCC8; color: #3E2723; font-weight: bold; text-transform: uppercase; font-size: 0.85rem; border-bottom: 2px solid #3E2723; }
        .article-content tr:nth-child(even) { background-color: #FBF8F5; }

        /* Quiz Styles */
        .quiz-section-overlay { display: none; animation: fadeIn 0.4s; }
        .quiz-start-btn {
            width: 100%; padding: 1.2rem; background: var(--color-primary); color: white;
            font-family: 'Cinzel', serif; font-weight: bold; font-size: 1.1rem; border: none;
            border-radius: 12px; cursor: pointer; margin-top: 2rem;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2); transition: all 0.3s;
        }
        .quiz-start-btn:hover { background: #3E2723; transform: scale(1.02); }
        .quiz-container { margin: 0; padding: 1rem; background: #fff; border-radius: 16px; text-align: left; }
        .quiz-header { font-family: 'Cinzel', serif; color: var(--color-primary); text-align: center; font-size: 1.6rem; margin-bottom: 1.5rem; border-bottom: 2px solid #eee; padding-bottom: 15px; }
        .quiz-back-btn { background: transparent; border: 2px solid var(--color-primary); color: var(--color-primary); padding: 8px 16px; border-radius: 20px; font-weight: bold; cursor: pointer; margin-bottom: 1rem; display: inline-flex; align-items: center; gap: 5px; }
        .quiz-back-btn:hover { background: var(--color-primary); color: white; }
        .quiz-item { margin-bottom: 2.5rem; border-bottom: 1px dashed #ddd; padding-bottom: 1.5rem; }
        .quiz-question { font-weight: bold; margin-bottom: 15px; color: #333; font-size: 1.1rem; }
        .quiz-options { display: grid; gap: 10px; }
        .quiz-btn { width: 100%; text-align: left; padding: 12px 15px; border: 1px solid #ccc; background: #f9f9f9; border-radius: 8px; cursor: pointer; transition: all 0.2s; font-size: 0.95rem; }
        .quiz-btn:hover { background: #eee; }
        .quiz-btn.correct { background: #C8E6C9; border-color: #2E7D32; color: #1B5E20; font-weight: bold; }
        .quiz-btn.wrong { background: #FFCDD2; border-color: #C62828; color: #B71C1C; opacity: 0.7; }
        .quiz-explanation { display: none; margin-top: 12px; padding: 12px; background-color: #E3F2FD; border-left: 4px solid #2196F3; border-radius: 4px; font-size: 0.9rem; color: #0D47A1; font-style: italic; animation: fadeIn 0.5s; }

        /* Action Bar */
        .action-bar { display: flex; justify-content: center; gap: 15px; margin-bottom: 2rem; border-bottom: 1px solid rgba(0,0,0,0.1); padding-bottom: 1rem; }
        .action-btn { background: #fff; border: 1px solid #ccc; color: var(--color-primary); width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.2s; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .action-btn:hover { background: var(--color-primary); color: #fff; transform: translateY(-2px); }
        .action-btn.active { background: var(--color-red); color: #fff; animation: pulse 1s infinite; border-color: var(--color-red); }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }

        /* Recommendations */
        .recommendations-area { margin-top: 2rem; padding: 1.5rem; background: rgba(255,255,255,0.5); border-radius: 12px; text-align: center; }
        .rec-title { font-family: 'Cinzel', serif; color: var(--color-primary); margin-bottom: 1rem; font-size: 1.1rem; }

        /* Images */
        .figure-hero { background: #fff; padding: 5px; border: 1px solid rgba(0,0,0,0.1); border-radius: 8px; margin-bottom: 2rem; width: 100%; max-height: 300px; overflow: hidden; }
        .figure-hero img { width: 100%; height: 100%; display: block; object-fit: cover; }
        .figure-inline { background: #fff; padding: 5px; border: 1px solid rgba(0,0,0,0.1); border-radius: 8px; max-width: 180px; float: right; margin-left: 1.5rem; margin-bottom: 1rem; margin-top: 5px; clear: right; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .figure-inline img { width: 100%; height: auto; border-radius: 4px; aspect-ratio: 3/4; object-fit: cover; }
        figcaption { font-size: 0.75rem; color: #666; padding: 8px 4px; text-align: center; background: #f9f9f9; border-top: 1px solid #eee; }
        figcaption a { color: var(--color-primary); text-decoration: none; font-weight: bold; display: inline-block; margin-top: 2px; }

        /* Library Modal */
        #libraryModal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 200; display: none; justify-content: center; align-items: center; backdrop-filter: blur(3px); }
        .modal-content { background: #fff; width: 90%; max-width: 600px; max-height: 80vh; border-radius: 16px; padding: 2rem; overflow-y: auto; box-shadow: 0 10px 40px rgba(0,0,0,0.3); }
        .saved-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid #eee; }
        .saved-item:last-child { border-bottom: none; }
        .saved-title { font-weight: bold; color: var(--color-primary); cursor: pointer; }
        .saved-title:hover { text-decoration: underline; }

        /* Print & Utils */
        @media print {
            header, .search-box, .chips-container, #scrollTopBtn, footer, .action-bar, .recommendations-area, .search-btn-group, #searchCard, .quiz-section-overlay, .fun-fact-box, #quizStartBtnArea, #bg-slideshow, .bg-overlay { display: none !important; }
            body { background: white; color: black; display: block; }
            .main-container { max-width: 100%; padding: 0; margin: 0; }
            .card-result { box-shadow: none; border: none; padding: 0; margin: 0; background: white; }
            .article-content { font-size: 12pt; }
            .hidden { display: block !important; }
            #resultContainer, #articleView { display: block !important; }
        }

        #scrollTopBtn { position: fixed; bottom: 30px; right: 30px; width: 50px; height: 50px; background: var(--color-primary); color: white; border: none; border-radius: 50%; box-shadow: 0 4px 10px rgba(0,0,0,0.3); cursor: pointer; z-index: 99; display: none; align-items: center; justify-content: center; transition: all 0.3s; }
        #scrollTopBtn:hover { transform: translateY(-5px); background: #4E342E; }

        footer { text-align: center; padding: 2rem; color: #fff; text-shadow: 0 1px 5px rgba(0,0,0,0.8); font-size: 0.9rem; background: transparent; margin-top: auto; }

        .hidden { display: none !important; }
        
        @media (max-width: 600px) {
            .hero-title { font-size: 2.2rem !important; }
            .card-result { padding: 1.5rem 1rem; }
            .figure-inline { float: right; max-width: 130px; margin-left: 0.8rem; } 
            .site-title { font-size: 1.2rem; }
            .header-content { justify-content: center; }
            .search-btn { padding: 0 20px; }
        }
    </style>
</head>
<body>

    <!-- BACKGROUND SLIDESHOW CONTAINERS -->
    <div id="bg-slideshow">
        <!-- Images will be injected here by JS -->
    </div>
    <div class="bg-overlay"></div>

    <div id="notification" class="hidden" style="position: fixed; top: 90px; right: 20px; background: #22c55e; color: white; padding: 12px 20px; border-radius: 8px; z-index: 1000; box-shadow: 0 4px 15px rgba(0,0,0,0.2);">
        <span id="notificationText">Message</span>
    </div>

    <div id="libraryModal">
        <div class="modal-content">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1.5rem;">
                <h2 style="font-family:'Cinzel'; margin:0; color:var(--color-primary);">Saved Archives</h2>
                <button onclick="toggleLibrary()" style="border:none; background:none; font-size:1.5rem; cursor:pointer;">&times;</button>
            </div>
            <div id="savedList">
                <p style="text-align:center; color:#888;">No saved articles found.</p>
            </div>
        </div>
    </div>

    <header class="site-header">
        <div class="header-content">
            <div class="logo-area">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="logo-icon">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 3L2 12h3v8h6v-6h2v6h6v-8h3L12 3z" />
                </svg>
                <h1 class="site-title">World History Portal</h1>
            </div>
            <button onclick="toggleLibrary()" class="library-btn">
                <svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z"></path></svg>
                My Library
            </button>
        </div>
    </header>

    <main class="main-container">
        
        <!-- SEARCH CARD (Now Transparent) -->
        <div id="searchCard">
            <div class="form-group" style="max-width: 300px; margin: 0 auto 2rem;">
                <label style="display:block; text-align:center; margin-bottom:0.5rem;">LANGUAGE / BAHASA</label>
                <select id="languageSelector" class="styled-select">
                    <option value="en" selected>English (Default)</option>
                    <option value="id">Bahasa Indonesia</option>
                    <option value="es">Espa√±ol</option>
                    <option value="fr">Fran√ßais</option>
                    <option value="de">Deutsch</option>
                    <option value="ja">Êó•Êú¨Ë™û</option>
                    <option value="ar">ÿßŸÑÿπÿ±ÿ®Ÿäÿ©</option>
                    <option value="zh">‰∏≠Êñá</option>
                    <option value="ko">Korean</option>
                </select>
            </div>

            <h2 class="hero-title">EXPLORE THE PAST</h2>
            <p class="subtitle">Enter a topic, person, or event to discover history.</p>

            <div class="search-box">
                <svg class="search-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                </svg>
                <input type="text" id="searchInput" class="styled-input styled-input-search" 
                       placeholder="e.g. Majapahit, Napoleon, Cold War..." onkeypress="handleEnter(event)">
                <button onclick="searchHistory()" class="search-btn">SEARCH</button>
            </div>

            <div class="chips-container">
                <button onclick="setQuery('Sejarah Candi Borobudur')" class="chip">Borobudur</button>
                <button onclick="setQuery('Revolusi Industri')" class="chip">Industrial Revolution</button>
                <button onclick="setQuery('Perang Dunia II')" class="chip">World War II</button>
            </div>
        </div>

        <div id="loadingState" class="loader-container">
            <div class="portal-ring">
                <div class="ring-outer"></div>
                <div class="ring-inner"></div>
            </div>
            <p style="color: var(--color-primary); font-weight: bold; font-size: 1.2rem; font-family: 'Cinzel', serif;">Opening Time Portal...</p>
            <p style="font-size: 0.9rem; color: #888; margin-top: 5px;">Consulting archives & retrieving images...</p>
            <button onclick="cancelSearch()" class="cancel-btn">Cancel Search</button>
        </div>

        <!-- RESULT CARD (Still Solid/Opaque for Readability) -->
        <div id="resultContainer" class="card-result hidden" style="text-align: left;">
            
            <div id="articleView">
                <div class="action-bar">
                    <button id="ttsBtn" onclick="toggleSpeech()" class="action-btn" title="Listen (Text-to-Speech)">
                        <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z"></path></svg>
                    </button>
                    <button onclick="saveToLibrary()" class="action-btn" title="Bookmark to Library">
                        <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z"></path></svg>
                    </button>
                    <button onclick="printArticle()" class="action-btn" title="Print / PDF">
                        <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"></path></svg>
                    </button>
                </div>

                <article id="contentBody" class="article-content">
                    </article>

                <div id="funFactContainer" class="fun-fact-box hidden">
                    <div class="fun-fact-title">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg>
                        DID YOU KNOW? / TAHUKAH ANDA?
                    </div>
                    <div id="funFactText" style="font-style: italic; color: #4E342E;"></div>
                </div>

                <div id="quizStartBtnArea" class="hidden">
                    <button onclick="showQuizView()" class="quiz-start-btn">
                        Start Quiz / Mulai Kuis (10 Questions)
                    </button>
                </div>

                <div id="recommendations" class="recommendations-area hidden">
                    <p class="rec-title">Explore Related Topics</p>
                    <div class="chips-container" id="recChips" style="margin-top:0;"></div>
                </div>

                <div style="margin-top: 3rem; padding-top: 1.5rem; border-top: 1px solid rgba(0,0,0,0.1);">
                    <h4 style="font-size: 0.9rem; color: #888; margin-bottom: 1rem; text-transform:uppercase; letter-spacing:1px;">Reference Sources:</h4>
                    <div id="sourcesList" style="font-size: 0.9rem; display: grid; gap: 8px;"></div>
                </div>
                
                <div class="search-btn-group" style="margin-top: 2.5rem; text-align: center; display:flex; justify-content:center; gap:15px;">
                    <button onclick="copyContent()" class="search-btn" style="position:static; background:#4E342E;">
                        Copy Text
                    </button>
                    <button onclick="resetSearch()" class="search-btn" style="position:static; background:#fff; color:var(--color-primary); border:2px solid var(--color-primary);">
                        New Search
                    </button>
                </div>
            </div>

            <div id="quizSection" class="quiz-section-overlay">
                <button onclick="closeQuizView()" class="quiz-back-btn">
                    <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
                    Back to Article / Kembali ke Artikel
                </button>

                <div class="quiz-container">
                    <h3 class="quiz-header">Knowledge Check / Kuis</h3>
                    <div id="quizList"></div>
                </div>
            </div>

        </div>

    </main>

    <button id="scrollTopBtn" onclick="scrollToTop()" title="Go to top">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="24" height="24">
            <path stroke-linecap="round" stroke-linejoin="round" d="M5 15l7-7 7 7" />
        </svg>
    </button>

    <footer>
        &copy; 2025 World History Portal. <br>
    </footer>

    <script>
        // --- BACKGROUND SLIDESHOW LOGIC (EXPANDED COLLECTION) ---
        const bgImages = [
            // --- Tempat Bersejarah (Historical Places) ---
            'https://images.unsplash.com/photo-1596402184320-417e7178b2cd?q=80&w=2070&auto=format&fit=crop', // Borobudur
            'https://images.unsplash.com/photo-1552832230-c0197dd311b5?q=80&w=1996&auto=format&fit=crop', // Colosseum Rome
            'https://images.unsplash.com/photo-1508804185872-d7badad00f7d?q=80&w=2070&auto=format&fit=crop', // Great Wall China
            'https://images.unsplash.com/photo-1564507592333-c60657eea523?q=80&w=2071&auto=format&fit=crop', // Taj Mahal
            'https://images.unsplash.com/photo-1526392060635-9d6019884377?q=80&w=2070&auto=format&fit=crop', // Machu Picchu
            'https://images.unsplash.com/photo-1579606038897-9b2c85c0659c?q=80&w=2069&auto=format&fit=crop', // Petra Jordan
            'https://images.unsplash.com/photo-1503177119275-0aa32b3a9368?q=80&w=2070&auto=format&fit=crop', // Pyramids Egypt
            'https://images.unsplash.com/photo-1555993539-1732b0258235?q=80&w=2070&auto=format&fit=crop', // Acropolis Greece

            // --- Tokoh & Patung (Figures & Statues) ---
            'https://images.unsplash.com/photo-1549887534-1541e9326642?q=80&w=2070&auto=format&fit=crop', // Greek Statue
            'https://images.unsplash.com/photo-1580489944761-15a19d654956?q=80&w=2061&auto=format&fit=crop', // Classical Sculpture
            'https://images.unsplash.com/photo-1519923041107-e4dc8d9193da?q=80&w=2070&auto=format&fit=crop', // Terracotta Warriors
            'https://images.unsplash.com/photo-1510525009512-ad7fc13eefab?q=80&w=2070&auto=format&fit=crop', // Moai Easter Island
            
            // --- Lukisan & Seni (Paintings & Art) ---
            'https://images.unsplash.com/photo-1577083552431-6e5fd01aa342?q=80&w=2006&auto=format&fit=crop', // Renaissance Art/Fresco
            'https://images.unsplash.com/photo-1566127444979-b3d2b654e3d7?q=80&w=2070&auto=format&fit=crop', // Egyptian Hieroglyphs Art
            
            // --- Dokumentasi & Peristiwa (Documentation & Events) ---
            'https://images.unsplash.com/photo-1461360370896-922624d12aa1?q=80&w=2074&auto=format&fit=crop', // Old Paper/Map
            'https://images.unsplash.com/photo-1524995997946-a1c2e315a42f?q=80&w=2070&auto=format&fit=crop', // Ancient Library/Books
            'https://images.unsplash.com/photo-1628268946761-666413e98092?q=80&w=2070&auto=format&fit=crop', // Old Compass/Navigation
            'https://images.unsplash.com/photo-1534260933201-cd883d19082f?q=80&w=2070&auto=format&fit=crop', // Vintage Plane (War Era)
            'https://images.unsplash.com/photo-1474487548417-781cb714d22f?q=80&w=2070&auto=format&fit=crop', // Steam Train/Industrial Revolution
            'https://images.unsplash.com/photo-1505566485473-98fa4b2ce699?q=80&w=2070&auto=format&fit=crop'  // Viking Ship
        ];

        // Shuffle array to ensure random starting order
        bgImages.sort(() => Math.random() - 0.5);

        let currentBgIndex = 0;
        const slideshowContainer = document.getElementById('bg-slideshow');

        // Create dual-layer div strategy for smooth crossfades
        const slide1 = document.createElement('div');
        slide1.className = 'bg-slide active';
        slide1.style.backgroundImage = `url('${bgImages[0]}')`;
        
        const slide2 = document.createElement('div');
        slide2.className = 'bg-slide';
        
        slideshowContainer.appendChild(slide1);
        slideshowContainer.appendChild(slide2);

        let activeSlide = slide1;
        let nextSlide = slide2;

        function loadNextImage() {
            currentBgIndex = (currentBgIndex + 1) % bgImages.length;
            const nextImageUrl = bgImages[currentBgIndex];

            // Preload image using Javascript Image object
            const imgLoader = new Image();
            imgLoader.src = nextImageUrl;

            imgLoader.onload = () => {
                // Image downloaded, now safe to swap
                nextSlide.style.backgroundImage = `url('${nextImageUrl}')`;
                
                activeSlide.classList.remove('active');
                nextSlide.classList.add('active');

                // Swap refs
                const temp = activeSlide;
                activeSlide = nextSlide;
                nextSlide = temp;

                // Schedule next change
                setTimeout(loadNextImage, 7000);
            };

            imgLoader.onerror = () => {
                console.log("Failed to load image, skipping");
                setTimeout(loadNextImage, 1000); // Try next image quicker
            };
        }

        // Start the smart loop
        setTimeout(loadNextImage, 7000);

        // --- EXISTING LOGIC ---
        const GEMINI_API_URL = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent";
        const GEMINI_API_KEY = "AIzaSyCWcrLL3CN9Ynz7V7l0Pg6L2djbMBMD01E"; 

        // UI Elements
        const searchInput = document.getElementById('searchInput');
        const searchCard = document.getElementById('searchCard');
        const resultContainer = document.getElementById('resultContainer');
        const loadingState = document.getElementById('loadingState');
        const contentBody = document.getElementById('contentBody');
        const languageSelector = document.getElementById('languageSelector');
        const notification = document.getElementById('notification');
        const scrollTopBtn = document.getElementById('scrollTopBtn');
        const ttsBtn = document.getElementById('ttsBtn');
        const libraryModal = document.getElementById('libraryModal');
        const recArea = document.getElementById('recommendations');
        const recChips = document.getElementById('recChips');
        
        // Quiz & Views Elements
        const funFactContainer = document.getElementById('funFactContainer');
        const funFactText = document.getElementById('funFactText');
        
        const articleView = document.getElementById('articleView');
        const quizSection = document.getElementById('quizSection');
        const quizStartBtnArea = document.getElementById('quizStartBtnArea');
        const quizList = document.getElementById('quizList');

        // Global Variables for Control
        let currentAbortController = null;
        let isSpeaking = false;
        let speechUtterance = null;
        let currentTitle = "";
        let currentImage = null;
        
        // Variables for Android TTS Logic
        let speechChunks = []; 
        let currentChunkIndex = 0;

        // Scroll to Top Logic
        window.onscroll = function() {
            if (document.body.scrollTop > 300 || document.documentElement.scrollTop > 300) {
                scrollTopBtn.style.display = "flex";
            } else {
                scrollTopBtn.style.display = "none";
            }
        };
        function scrollToTop() {
            window.scrollTo({top: 0, behavior: 'smooth'});
        }

        function setQuery(text) {
            searchInput.value = text;
            searchHistory();
        }

        function handleEnter(e) {
            if (e.key === 'Enter') searchHistory();
        }

        function resetSearch() {
            stopSpeech();
            resultContainer.classList.add('hidden');
            searchCard.classList.remove('hidden');
            searchInput.value = '';
            closeQuizView(); // Ensure we reset view
            window.scrollTo({top: 0, behavior: 'smooth'});
        }

        function showNotification(msg) {
            document.getElementById('notificationText').innerText = msg;
            notification.classList.remove('hidden');
            setTimeout(() => notification.classList.add('hidden'), 2500);
        }

        function cancelSearch() {
            if (currentAbortController) {
                currentAbortController.abort();
                currentAbortController = null;
            }
            loadingState.style.display = 'none';
            searchCard.classList.remove('hidden');
            showNotification("Search cancelled");
        }

        // --- QUIZ VIEW TOGGLE LOGIC ---
        function showQuizView() {
            articleView.style.display = 'none';
            quizSection.style.display = 'block';
            window.scrollTo({top: 0, behavior: 'smooth'});
        }

        function closeQuizView() {
            quizSection.style.display = 'none';
            articleView.style.display = 'block';
            window.scrollTo({top: 0, behavior: 'smooth'});
        }

        // --- TTS LOGIC ---
        function toggleSpeech() {
            if (isSpeaking) {
                stopSpeech();
            } else {
                startSpeech();
            }
        }

        function startSpeech() {
            const text = contentBody.innerText; 
            if (!text) return;
            stopSpeech();
            isSpeaking = true;
            ttsBtn.classList.add('active');

            const langCode = languageSelector.value;
            const selectedLang = langCode === 'id' ? 'id-ID' : 
                                 langCode === 'es' ? 'es-ES' : 
                                 langCode === 'fr' ? 'fr-FR' :
                                 langCode === 'de' ? 'de-DE' :
                                 langCode === 'ja' ? 'ja-JP' : 'en-US';

            speechChunks = text.match(/[^.!?]+[.!?]+["']?|[^.!?]+$/g) || [text];
            currentChunkIndex = 0;
            speakNextChunk(selectedLang);
        }

        function speakNextChunk(lang) {
            if (currentChunkIndex >= speechChunks.length || !isSpeaking) {
                stopSpeech(); 
                return;
            }
            const chunk = speechChunks[currentChunkIndex];
            if (!chunk.trim()) {
                currentChunkIndex++;
                speakNextChunk(lang);
                return;
            }
            speechUtterance = new SpeechSynthesisUtterance(chunk);
            speechUtterance.lang = lang;
            speechUtterance.rate = 0.9; 
            speechUtterance.onend = () => {
                currentChunkIndex++;
                if (isSpeaking) {
                    speakNextChunk(lang);
                }
            };
            speechUtterance.onerror = (e) => {
                console.error("TTS Error:", e);
                currentChunkIndex++;
                if (isSpeaking) speakNextChunk(lang);
            };
            speechSynthesis.speak(speechUtterance);
        }

        function stopSpeech() {
            isSpeaking = false;
            if (speechSynthesis) {
                speechSynthesis.cancel(); 
            }
            ttsBtn.classList.remove('active');
            speechChunks = [];
            currentChunkIndex = 0;
        }

        function saveToLibrary() {
            if (!contentBody.innerHTML) return;
            
            const savedItem = {
                id: Date.now(),
                title: currentTitle || searchInput.value,
                html: contentBody.innerHTML,
                funfact: funFactText.innerHTML, 
                image: currentImage ? currentImage.url : null,
                date: new Date().toLocaleDateString()
            };

            let library = JSON.parse(localStorage.getItem('historyLibrary')) || [];
            const exists = library.some(item => item.title === savedItem.title);
            if(exists) {
                showNotification("Article already saved!");
                return;
            }

            library.push(savedItem);
            localStorage.setItem('historyLibrary', JSON.stringify(library));
            showNotification("Saved to Library!");
        }

        function toggleLibrary() {
            const isHidden = libraryModal.style.display === 'none' || libraryModal.style.display === '';
            if (isHidden) {
                renderLibrary();
                libraryModal.style.display = 'flex';
            } else {
                libraryModal.style.display = 'none';
            }
        }

        function renderLibrary() {
            const list = document.getElementById('savedList');
            let library = JSON.parse(localStorage.getItem('historyLibrary')) || [];
            
            if (library.length === 0) {
                list.innerHTML = '<p style="text-align:center; color:#888;">No saved articles found.</p>';
                return;
            }

            let html = '';
            library.reverse().forEach(item => {
                html += `
                <div class="saved-item">
                    <div>
                        <div class="saved-title" onclick="loadSavedArticle(${item.id})">${item.title}</div>
                        <small style="color:#888;">Saved: ${item.date}</small>
                    </div>
                    <button onclick="deleteSaved(${item.id})" style="color:red; border:none; background:none; cursor:pointer;">üóëÔ∏è</button>
                </div>`;
            });
            list.innerHTML = html;
        }

        function loadSavedArticle(id) {
            let library = JSON.parse(localStorage.getItem('historyLibrary')) || [];
            const item = library.find(i => i.id === id);
            if (item) {
                contentBody.innerHTML = item.html;
                currentTitle = item.title;
                
                if (item.funfact) {
                    funFactText.innerHTML = item.funfact;
                    funFactContainer.classList.remove('hidden');
                } else {
                    funFactContainer.classList.add('hidden');
                }

                // Reset Views
                closeQuizView();
                quizStartBtnArea.classList.add('hidden'); // Hide quiz button for saved items (cannot regenerate quiz simply)
                
                searchCard.classList.add('hidden');
                loadingState.style.display = 'none';
                resultContainer.classList.remove('hidden');
                recArea.classList.add('hidden');
                libraryModal.style.display = 'none';
                document.getElementById('sourcesList').innerHTML = '<p>Offline Copy</p>';
            }
        }

        function deleteSaved(id) {
            let library = JSON.parse(localStorage.getItem('historyLibrary')) || [];
            library = library.filter(i => i.id !== id);
            localStorage.setItem('historyLibrary', JSON.stringify(library));
            renderLibrary();
        }

        function printArticle() {
            window.print();
        }

        // --- QUIZ RENDER LOGIC ---
        function renderQuiz(jsonString) {
            try {
                const cleanedJson = jsonString.replace(/```json/g, '').replace(/```/g, '').trim();
                const quizData = JSON.parse(cleanedJson);

                if (!quizData || quizData.length === 0) return;

                let html = '';
                quizData.forEach((q, index) => {
                    let optionsHtml = '';
                    const safeExplanation = q.explanation ? q.explanation.replace(/'/g, "&#39;") : "Correct answer.";

                    q.options.forEach((opt, optIndex) => {
                        optionsHtml += `<button class="quiz-btn" data-opt-index="${optIndex}" onclick="checkAnswer(this, ${optIndex === q.answer_index}, ${q.answer_index}, 'exp-${index}')">${opt}</button>`;
                    });

                    html += `
                        <div class="quiz-item">
                            <div class="quiz-question">${index + 1}. ${q.question}</div>
                            <div class="quiz-options">${optionsHtml}</div>
                            <div id="exp-${index}" class="quiz-explanation">
                                <strong>Explanation:</strong>
                                ${q.explanation || "No explanation provided."}
                            </div>
                        </div>
                    `;
                });
                quizList.innerHTML = html;
                quizStartBtnArea.classList.remove('hidden'); // Show the start button
            } catch (e) {
                console.error("Quiz Parsing Error", e);
                quizStartBtnArea.classList.add('hidden');
            }
        }

        function checkAnswer(btn, isCorrect, correctIndex, expId) {
            const parent = btn.parentElement;
            const allBtns = parent.querySelectorAll('button');
            
            allBtns.forEach(b => {
                b.disabled = true;
                b.style.cursor = 'default';
                if (parseInt(b.getAttribute('data-opt-index')) === correctIndex) {
                    b.classList.add('correct');
                }
            });

            if (!isCorrect) {
                btn.classList.add('wrong');
                showNotification("Incorrect. See explanation.");
            } else {
                showNotification("Correct Answer! üéâ");
            }

            const expBox = document.getElementById(expId);
            if (expBox) {
                expBox.style.display = 'block';
            }
        }

        async function fetchWikiImage(query, lang, width = 400) {
            try {
                const searchUrl = `https://${lang}.wikipedia.org/w/api.php?action=query&list=search&srsearch=${encodeURIComponent(query)}&format=json&origin=*`;
                const searchRes = await fetch(searchUrl);
                const searchData = await searchRes.json();
                
                if (!searchData.query || !searchData.query.search || searchData.query.search.length === 0) {
                    if (lang !== 'en') return fetchWikiImage(query, 'en', width);
                    return null;
                }

                const title = searchData.query.search[0].title;
                const imgUrl = `https://${lang}.wikipedia.org/w/api.php?action=query&titles=${encodeURIComponent(title)}&prop=pageimages&format=json&pithumbsize=${width}&origin=*`;
                const imgRes = await fetch(imgUrl);
                const imgData = await imgRes.json();
                
                const pages = imgData.query.pages;
                const pageId = Object.keys(pages)[0];
                const src = pages[pageId].thumbnail?.source;

                if (src) {
                    return { 
                        url: src, 
                        title: title, 
                        source: `https://${lang}.wikipedia.org/wiki/${encodeURIComponent(title)}` 
                    };
                }
            } catch (e) {
                console.error("Wiki Image Error", e);
            }
            return null;
        }

        function renderMarkdown(text, docImg, figImgs) {
            const funFactSplit = text.split('---FUNFACT---');
            let mainText = funFactSplit[0];
            let remainder = funFactSplit[1] || '';

            const quizSplit = remainder.split('---QUIZJSON---');
            let funFactContent = quizSplit[0];
            let remainder2 = quizSplit[1] || '';

            const recSplit = remainder2.split('---RECOMMENDATIONS---');
            let quizJsonContent = recSplit[0];
            let recContent = recSplit[1] || '';

            // 1. Render Main Content
            let html = DOMPurify.sanitize(marked.parse(mainText));

            if (docImg) {
                currentImage = docImg; 
                const imgHtml = `
                    <figure class="figure-hero">
                        <img src="${docImg.url}" onerror="this.style.display='none'">
                        <figcaption>${docImg.title}<br><a href="${docImg.source}" target="_blank">[Sumber Foto: Wikipedia]</a></figcaption>
                    </figure>`;
                
                if (html.includes('[GAMBAR:')) {
                    html = html.replace(/\[GAMBAR:.*?\]/, imgHtml);
                } else {
                    html = imgHtml + html;
                }
            }
            html = html.replace(/\[GAMBAR:.*?\]/g, ''); 

            if (figImgs && figImgs.length > 0) {
                figImgs.forEach(fig => {
                    const imgHtml = `
                        <figure class="figure-inline">
                            <img src="${fig.url}" onerror="this.style.display='none'">
                            <figcaption>${fig.title}<br><a href="${fig.source}" target="_blank">[Sumber]</a></figcaption>
                        </figure>`;
                    
                    const safeName = fig.queryName.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                    const regex = new RegExp(`\\[FIGUR:\\s*${safeName}.*?\\]`, 'i');
                    
                    if (regex.test(html)) {
                        html = html.replace(regex, imgHtml);
                    }
                });
            }
            html = html.replace(/\[FIGUR:.*?\]/g, '');

            // --- WRAP TABLES FOR SCROLLING (NEW FEATURE) ---
            // We use a regex replace to wrap <table> in <div class="table-scroll-container">
            html = html.replace(/<table/g, '<div class="table-scroll-container"><table');
            html = html.replace(/<\/table>/g, '</table></div>');

            contentBody.innerHTML = html;

            // 2. Render Fun Fact
            if (funFactContent && funFactContent.trim().length > 0) {
                funFactText.innerText = funFactContent.trim();
                funFactContainer.classList.remove('hidden');
            } else {
                funFactContainer.classList.add('hidden');
            }

            // 3. Render Quiz (Preload data, but don't show view yet)
            if (quizJsonContent && quizJsonContent.trim().length > 0) {
                renderQuiz(quizJsonContent);
            } else {
                quizStartBtnArea.classList.add('hidden');
            }
            
            // 4. Render Recs
            if (recContent && recContent.trim().length > 0) {
                parseRecommendations(recContent);
            } else {
                recArea.classList.add('hidden');
            }
        }

        function parseRecommendations(rawText) {
            const topics = rawText.replace(/RELATED:/g, '').split(',').map(t => t.trim()).filter(t => t.length > 0);
            
            if (topics.length > 0) {
                let html = '';
                topics.forEach(topic => {
                    html += `<button onclick="setQuery('${topic}')" class="chip" style="border-color:var(--color-accent); color:#3E2723; background:#fff;">${topic}</button>`;
                });
                recChips.innerHTML = html;
                recArea.classList.remove('hidden');
            }
        }

        async function searchHistory() {
            const query = searchInput.value.trim();
            if (!query) return;

            currentTitle = query;
            const langCode = languageSelector.value; 
            const langName = languageSelector.options[languageSelector.selectedIndex].text;

            searchCard.classList.add('hidden');
            loadingState.style.display = 'flex'; 
            resultContainer.classList.add('hidden');
            recArea.classList.add('hidden');
            funFactContainer.classList.add('hidden');
            quizStartBtnArea.classList.add('hidden');
            stopSpeech();
            closeQuizView(); // Reset to article view
            window.scrollTo({top: 0, behavior: 'smooth'});

            currentAbortController = new AbortController();
            const signal = currentAbortController.signal;

            const prompt = `
                Act as an expert World Historian. 
                Task: Create a comprehensive historical article about: "${query}".
                
                **VALIDATION**: If the topic is NOT about history (e.g., math, sports news, celebrities, coding), REFUSE neatly in ${langName}.
                
                **LANGUAGE**: Write the entire response in **${langName}**.
                
                **STRUCTURE**:
                # Main Title (H1)
                [GAMBAR: ${query}]
                ## Background
                ## Main Events
                ## Key Figures
                (Important: When you mention a key person for the first time, insert tag [FIGUR: Person Name] immediately after their name.)
                ## Data Table (Required if possible)
                (If there is data like timeline, stats, or comparison, create a Markdown TABLE here.)
                ## Impact & Legacy
                
                **FORMAT**: 
                - Use **bold** for important dates/names. 
                
                **MANDATORY ENDING (STRICT FORMAT)**:
                1. After the article, add exactly "---FUNFACT---" followed by one surprising/interesting sentence about this topic.
                
                2. Then, add exactly "---QUIZJSON---" followed by a JSON Array of **10 multiple choice questions** based on the text above.
                Format Example: 
                [
                    {
                        "question": "Who was...?",
                        "options": ["A","B","C","D"],
                        "answer_index": 0,
                        "explanation": "Explain briefly why this answer is correct in ${langName}."
                    },
                    ...
                ]
                (Ensure it is valid JSON. Ensure there are exactly 10 items).

                3. Finally, add exactly "---RECOMMENDATIONS---" followed by 3 related topics separated by commas.
            `;

            try {
                const res = await fetch(`${GEMINI_API_URL}?key=${GEMINI_API_KEY}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }] }],
                        tools: [{ google_search: {} }]
                    }),
                    signal: signal
                });

                const data = await res.json();
                const candidate = data.candidates?.[0];
                const text = candidate?.content?.parts?.[0]?.text || "Error: No content generated.";

                const docImgPromise = fetchWikiImage(query, langCode, 600);
                
                const figureMatches = [...text.matchAll(/\[FIGUR:\s*(.*?)\]/g)];
                const uniqueFigures = [...new Set(figureMatches.map(m => m[1]))];
                
                const figImgPromises = uniqueFigures.map(name => 
                    fetchWikiImage(name, langCode, 300).then(img => img ? { ...img, queryName: name } : null)
                );

                const [docImg, ...rawFigImgs] = await Promise.all([docImgPromise, ...figImgPromises]);

                const distinctFigImgs = [];
                const seenUrls = new Set();
                
                if(docImg && docImg.url) seenUrls.add(docImg.url); 

                rawFigImgs.forEach(fig => {
                    if(fig && fig.url && !seenUrls.has(fig.url)) {
                        seenUrls.add(fig.url);
                        distinctFigImgs.push(fig);
                    }
                });

                renderMarkdown(text, docImg, distinctFigImgs);

                const sourcesDiv = document.getElementById('sourcesList');
                sourcesDiv.innerHTML = '';
                if (candidate?.groundingMetadata?.groundingAttributions) {
                    candidate.groundingMetadata.groundingAttributions.forEach(src => {
                        if(src.web?.uri) {
                            sourcesDiv.innerHTML += `<a href="${src.web.uri}" target="_blank" style="display:block; color:#6D4C41; margin-bottom:4px; text-decoration:none;">üîó ${src.web.title || 'Reference Source'}</a>`;
                        }
                    });
                }

                loadingState.style.display = 'none';
                resultContainer.classList.remove('hidden');

            } catch (err) {
                if (err.name === 'AbortError') {
                    console.log('Fetch aborted');
                } else {
                    alert("Error: " + err.message);
                    loadingState.style.display = 'none';
                    searchCard.classList.remove('hidden');
                }
            }
        }

        function copyContent() {
            navigator.clipboard.writeText(contentBody.innerText);
            showNotification("Article text copied to clipboard!");
        }
    </script>
</body>
</html>
